<!-- AMap.PlaceSearch + jquery.twbsPagination -->
<!doctype html>
<html lang="zh-CN">

<head>
    <!-- 原始地址：//webapi.amap.com/ui/1.0/ui/misc/MarkerList/examples/pagination.html -->
    <base href="//webapi.amap.com/ui/1.0/ui/misc/MarkerList/examples/" />
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>搜索+分页</title>
    <link rel="stylesheet" type="text/css" href="./index.css">
    <link rel="stylesheet" type="text/css" href="//a.amap.com/amap-ui/static/1.0/ui/misc/MarkerList/examples/pagination.css">
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style>

    .amap-marker .marker-route {
        position: absolute;
        width: 40px;
        height: 44px;
        color: #e90000;
        background: url(http://webapi.amap.com/theme/v1.3/images/newpc/poi-1.png) no-repeat;
        cursor: pointer;
    }
    .amap-marker .marker-marker-bus-from {
        background-position: -334px -180px;
    }


    #outer-box {
        height: 100%;
        padding-right: 0px;
    }
    #panel{
        height: auto;
        border: 1px solid #eaeaea;
        max-height: 347px;
    }
    .map-search-wrapper{ 
        display: flex;
        padding: 5px;
        position: absolute;
        z-index: 99999;
        top:5px;
      }

      .map-search-wrapper .searchPlace{
        height: 25px;
        padding: 16px;
        box-sizing: border-box;
      }
      .map-search-wrapper .dropdown{

        z-index: 99999;
      }

      .map-search-wrapper .dropdown{
        position: absolute;
        top: 49px;
        left: 22px;
        z-index: 999999999999999;
        display:block;
        float: left;
        min-width: 160px;
        padding: 10px;
        margin: 2px 0 0;
        font-size: 14px;
        text-align: left;
        list-style: none;
        background-color: #fff;
        -webkit-background-clip: padding-box;
        background-clip: padding-box;
        border: 1px solid #ccc;
        border: 1px solid rgba(0,0,0,.15);
        border-radius: 4px;
        -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
        box-shadow: 0 6px 12px rgba(0,0,0,.175)
      }
      .dropdown-menu{
        display: block;
      }

      #panel {
        position: absolute;
        top: 0;
        bottom: 0;
        right: 0;
        left: 20px;
        top: 44px;
        height: 100%;
        overflow: auto;
        width: 303px;
        z-index: 999;
        border-left: 1px solid #eaeaea;
        background: #fff;
    }
    </style>
</head>

<body>
    <div id="outer-box">
        <div id="container" tabindex="0"></div>

         <div class="map-search-wrapper">
                <div class="col-lg-3">
                    <div class="input-group">
                      <input type="text" class="form-control" placeholder="搜索站点地址" id="keywords">
                      <span class="input-group-btn">
                        <button id="mapSearch" class="btn" style="background: #338ca5; color: #fff;" type="button">搜索</button>
                      </span>
                    </div><!-- /input-group -->
                </div><!-- /.col-lg-6 -->
        </div><!-- /.row -->

             <div id="panel" style="height: auto;">
                  <!--   <ul id="pagination-demo" class="pagination-sm"></ul> -->
                    <ul id="myList">
                    </ul>
                </div>

    </div>

    <script type="text/javascript" src='//webapi.amap.com/maps?v=1.3&key=c72c128531b240087fe95ff8ca5e44a1&plugin=AMap.ToolBar'></script>
    <!-- UI组件库 1.0 -->
    <script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.10"></script>
    <script type="text/javascript">
    //创建地图




    AMapUI.loadUI(['misc/MarkerList', 'overlay/SimpleMarker', 'overlay/SimpleInfoWindow','misc/PositionPicker'],
        function(MarkerList, SimpleMarker, SimpleInfoWindow,PositionPicker) {
            var map = new AMap.Map('container', {
                zoom: 9,
                center: [121.339766,31.196099]
            });

            //即jQuery/Zepto
            var $ = MarkerList.utils.$;

            var defaultIconStyle = 'red', //默认的图标样式
                hoverIconStyle = 'green', //鼠标hover时的样式
                selectedIconStyle = 'purple' //选中时的图标样式
            ;

            var markerList = new MarkerList({
                map: map,
                //ListElement对应的父节点或者ID
                listContainer: "myList", //document.getElementById("myList"),
                //选中后显示

                //从数据中读取位置, 返回lngLat
                getPosition: function(item) {
                    return item.location;
                },
                //数据ID，如果不提供，默认使用数组索引，即index
                getDataId: function(item, index) {

                    return item.id;
                },
                getInfoWindow: function(data, context, recycledInfoWindow) {

                    if (recycledInfoWindow) {

                        recycledInfoWindow.setInfoTitle(data.name);
                        recycledInfoWindow.setInfoBody(data.address);

                        return recycledInfoWindow;
                    }

                    return new SimpleInfoWindow({
                        infoTitle: data.name,
                        infoBody: data.address,
                        offset: new AMap.Pixel(0, -37)
                    });
                },
                //构造marker用的options对象, content和title支持模板，也可以是函数，返回marker实例，或者返回options对象
                getMarker: function(data, context, recycledMarker) {

                    var label = String.fromCharCode('A'.charCodeAt(0) + context.index);

                    if (recycledMarker) {
                        recycledMarker.setIconLabel(label);
                        return;
                    }

                    return new SimpleMarker({
                        containerClassNames: 'my-marker',
                        iconStyle: defaultIconStyle,
                        iconLabel: label
                    });
                },
                //构造列表元素，与getMarker类似，可以是函数，返回一个dom元素，或者模板 html string
                getListElement: function(data, context, recycledListElement) {

                    var label = String.fromCharCode('A'.charCodeAt(0) + context.index);

                    //使用模板创建
                    var innerHTML = MarkerList.utils.template(
                        '<% if(data.photos && data.photos[0]) { %>' +
                        // '<div class="poi-imgbox">' +
                        // '    <span class="poi-img" style="background-image:url(<%- data.photos[0].url %>)"></span>' +
                        // '</div>' +
                        '<% } %>' +
                        '<div class="poi-info-left">' +
                        '    <h3 class="poi-title">' +
                        '        <%- label %>. <%- data.name %>' +
                        '    </h3>' +
                        '    <div class="poi-info">' +
                        '        <p class="poi-addr">地址：<%- data.address %></p>' +
                        '<% if(data.tel ){ %>' +
                        // '        <p class="poi-addr">电话：<%- data.tel %></p>' +
                        '<% } %>' +
                        '    </div>' +
                        '</div>' +
                        '<div class="clear"></div>', {
                            data: data,
                            label: label
                        });

                    if (recycledListElement) {
                        recycledListElement.innerHTML = innerHTML;
                        return recycledListElement;
                    }

                    return '<li class="poibox">' +
                        innerHTML +
                        '</li>';
                },
                //列表节点上监听的事件
                listElementEvents: ['click', 'mouseenter', 'mouseleave'],
                //marker上监听的事件
                markerEvents: ['click', 'mouseover', 'mouseout'],
                //makeSelectedEvents:false,
                selectedClassNames: 'selected',
                autoSetFitView: true
            });

            window.markerList = markerList;

        var marker = new AMap.Marker({ //添加自定义点标记
            map: map,
            position: map.getCenter(), //基点位置
            offset: new AMap.Pixel(-17, -42), //相对于基点的偏移位置
            draggable: true,  //是否可拖动
            content: '<div class="marker-route marker-marker-bus-from"></div>'   //自定义点标记覆盖物内容
        });


        var infoWindow = new SimpleInfoWindow({

            infoTitle:  '<strong>新增站点</strong>',
            infoBody:   '<div><input type="text" placeholder="站点名称"></div>'+
                        '<div><input type="text" placeholder="站点地址"></div>'+
                        '<div><select><option>站点属性</option><option>上行</option><option>下行</option></select></div>'+
                        '<div><button>取消</button><button>确认</button></div>',

            //基点指向marker的头部位置
            offset: new AMap.Pixel(0, -31)
        });


        function openInfoWin() {
            infoWindow.open(map, marker.getPosition());
        }

        AMap.event.addListener(marker, 'click', function() {
            openInfoWin();
        });
            /************通过拖拽定位站点 ******************/  
        //         var positionPicker = new PositionPicker({
        //             mode: 'dragMarker',
        //             map: map,
        //             iconStyle: { //自定义外观
        //                 url: '//webapi.amap.com/ui/1.0/assets/position-picker2.png',
        //                 ancher: [24, 40],
        //                 size: [48, 48]
        //             }
        //         });
        // AMap.event.addListener(positionPicker, 'click', function() {
        //    alert('hi')
        // });
        //         positionPicker.on('success', function(positionResult) {
        //             alert(positionResult.position)
        //             console.log('----position----')
        //             console.log(positionResult.position)
        //             document.getElementById('lnglat').innerHTML = positionResult.position;
        //             document.getElementById('address').innerHTML = positionResult.address;
        //             document.getElementById('nearestJunction').innerHTML = positionResult.nearestJunction;
        //             document.getElementById('nearestRoad').innerHTML = positionResult.nearestRoad;
        //             document.getElementById('nearestPOI').innerHTML = positionResult.nearestPOI;
        //         });
                // positionPicker.on('fail', function(positionResult) {
                //     document.getElementById('lnglat').innerHTML = ' ';
                //     document.getElementById('address').innerHTML = ' ';
                //     document.getElementById('nearestJunction').innerHTML = ' ';
                //     document.getElementById('nearestRoad').innerHTML = ' ';
                //     document.getElementById('nearestPOI').innerHTML = ' ';
                // });
                // var onModeChange = function(e) {
                //     positionPicker.setMode(e.target.value)
                // }
                // var startButton = document.getElementById('start');
                // var stopButton = document.getElementById('stop');
                // var dragMapMode = document.getElementsByName('mode')[0];
                // var dragMarkerMode = document.getElementsByName('mode')[1];
                // AMap.event.addDomListener(startButton, 'click', function() {
                //     positionPicker.start(map.getBounds().getSouthWest())
                // })
                // AMap.event.addDomListener(stopButton, 'click', function() {
                //     positionPicker.stop();
                // })
                // AMap.event.addDomListener(dragMapMode, 'change', onModeChange)
                // AMap.event.addDomListener(dragMarkerMode, 'change', onModeChange);
                // positionPicker.start();

                // map.addControl(new AMap.ToolBar({
                //     liteStyle: true
                // }))

            /************************************/
             


            AMap.plugin(["AMap.PlaceSearch"], function() {

                var placeSearch = new AMap.PlaceSearch({ //构造地点查询类
                    pageSize: 5,
                    pageIndex: 1,
                    extensions: 'all',
                    city: "021" //城市
                });

                var $pagination = $('#pagination-demo');

                function initPagination(page, totalPages) {

                    //初始化分页器
                    $pagination.twbsPagination({
                        totalPages: totalPages,
                        startPage: page,
                        prev: null,
                        first: '首页',
                        next: '下一页',
                        last: null,
                        initiateStartPageClick: false,
                        onPageClick: function(event, page) {
                            goPage(page);
                        }
                    });
                }

                var inited = false;

                var $keywords = $('#keywords');

                function goPage(page) {

                    //设置当前页
                    placeSearch.setPageIndex(page);
                    //关键字查询
                    placeSearch.search($keywords.val(), function(status, result) {

                        if (status !== 'complete') {
                            alert('返回数据出错!');
                        }

                        console.log('------------poiList-----')
                        console.log(1,result.poiList)
                        //render当前页的数据
                        markerList.render(result.poiList.pois);

                        if (!inited) {
                            inited = true;
                            //首次初始化
                            initPagination(page, Math.ceil(result.poiList.count / result.poiList.pageSize));
                        }

                    });
                }

                goPage(1);

                $keywords.on('keypress', function(e) {
                    if (e.which === 13) {
                        inited = false;
                        $pagination.twbsPagination('destroy');
                        goPage(1);
                    }
                });
            });

            markerList.on('selectedChanged', function(event, info) {

                if (info.selected) {

                    if (info.selected.marker) {
                        //更新为选中样式
                        info.selected.marker.setIconStyle(selectedIconStyle);
                    }
                }

                if (info.unSelected && info.unSelected.marker) {
                    //更新为默认样式
                    info.unSelected.marker.setIconStyle(defaultIconStyle);
                }
            });


            markerList.on('listElementMouseenter markerMouseover', function(event, record) {

                if (record && record.marker) {
                    //非选中的id
                    if (!this.isSelectedDataId(record.id)) {
                        //设置为hover样式
                        record.marker.setIconStyle(hoverIconStyle);
                        //this.closeInfoWindow();
                    }
                }
            });

            markerList.on('listElementMouseleave markerMouseout', function(event, record) {

                if (record && record.marker) {

                    if (!this.isSelectedDataId(record.id)) {
                        //恢复默认样式
                        record.marker.setIconStyle(defaultIconStyle);
                    }
                }
            });


        });
    </script>
</body>

</html>